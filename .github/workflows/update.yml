name: BotLi files ko sync karna haiiiii

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */2 * * *"

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout our repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN }}

      - name: Configure Git identity
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"

      - name: Add BotLi remote and fetch
        run: |
          git remote add botli https://github.com/Torom/BotLi.git || echo "BotLi remote already exists"
          git fetch botli main

      - name: Sync Python files
        run: |
          py_files=$(git ls-tree -r --name-only botli/main | grep '\.py$' | grep -v 'chatter.py')
          for f in $py_files; do
            echo "Syncing $f with patch..."
            git diff botli/main -- "$f" > update.patch
            if [ -s update.patch ]; then
              git apply update.patch
              echo "Applied updates to $f"
            else
              echo "No updates for $f"
            fi
            rm -f update.patch
          done

          if [ -f chatter.py ]; then
            echo "Merging BotLi updates into chatter.py..."
            cp chatter.py chatter_custom.py
            git checkout botli/main -- chatter.py

            awk '
              BEGIN { in_custom=0 }
              /^    # CUSTOM FUNCTION START$/ { in_custom=1; print; next }
              /^    # CUSTOM FUNCTION END$/ { in_custom=0; print; next }
              in_custom { next }
              { print }
            ' chatter.py > chatter_tmp.py

            awk '
              /^    # CUSTOM FUNCTION START$/ { in_custom=1 }
              in_custom { print; if (/^    # CUSTOM FUNCTION END$/) in_custom=0 }
            ' chatter_custom.py >> chatter_tmp.py

            mv chatter_tmp.py chatter.py
            rm -f chatter_custom.py
          else
            echo "chatter.py does not exist locally, fetching from BotLi..."
            git checkout botli/main -- chatter.py
          fi

          git add .
          git commit -m "Sync BotLi Python files (merged chatter.py custom functions)" || echo "No changes to commit"

      - name: Push changes
        run: git push origin main
