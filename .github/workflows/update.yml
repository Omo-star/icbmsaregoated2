name: Sync BotLi files (keep custom chatter logic)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */2 * * *"  # runs every 2 hours

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout current repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN }}

      - name: Configure Git identity
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"

      - name: Add BotLi remote and fetch
        run: |
          git remote add botli https://github.com/Torom/BotLi.git || echo "BotLi remote already exists"
          git fetch botli main

      - name: Sync .py and .txt files (except chatter.py)
        run: |
          echo "Syncing Python and text files from BotLi/main..."
          files=$(git ls-tree -r --name-only botli/main | grep -E '\.py$|\.txt$' | grep -v 'chatter.py')

          for f in $files; do
            echo "Updating $f..."
            mkdir -p "$(dirname "$f")"
            git checkout botli/main -- "$f"
          done

      - name: Merge BotLi chatter.py (keep custom functions)
        run: |
          if [ -f chatter.py ]; then
            echo "Preserving custom chatter.py logic..."
            cp chatter.py chatter_custom.py
            git checkout botli/main -- chatter.py

            awk '
              BEGIN { in_custom=0 }
              /^    # CUSTOM FUNCTION START$/ { in_custom=1; print; next }
              /^    # CUSTOM FUNCTION END$/ { in_custom=0; print; next }
              in_custom { next }
              { print }
            ' chatter.py > chatter_tmp.py

            awk '
              /^    # CUSTOM FUNCTION START$/ { in_custom=1 }
              in_custom { print; if (/^    # CUSTOM FUNCTION END$/) in_custom=0 }
            ' chatter_custom.py >> chatter_tmp.py

            mv chatter_tmp.py chatter.py
            rm -f chatter_custom.py
          else
            echo "No local chatter.py found â€” pulling from BotLi..."
            git checkout botli/main -- chatter.py
          fi

      - name: Commit and push changes
        run: |
          git add .
          git commit -m "Sync BotLi .py and .txt files (preserved custom chatter.py logic)" || echo "No changes to commit"
          git push origin main
